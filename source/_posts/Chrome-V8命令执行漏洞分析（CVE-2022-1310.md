---
title: Chrome V8命令执行漏洞分析（CVE-2022-1310）
top_img: https://s2.loli.net/2022/09/04/v39sB8VlQuOgknP.png
cover: https://www.apple.com.cn/newsroom/images/values/corporate/standard/Apple_google-partner-on-covid-19-contact-tracing-technology_04102020_inline.jpg.large_2x.jpg
date: 2022-09-04 20:01:52
tags:
        - 漏洞
        - 前端
        - JavaScript
categories: 
            - [安全]
            - [底层]
---

# 前言

>Google 于 2022 年 4 月 11 日更新了 Chrome 的 100.0.4896.88，其中修复了由@btiszka 在 3 月 18 日报告的正则表达式模块的 UAF 漏洞；6 月 28 日，Google 纰漏出了该漏洞的具体细节，该当前漏洞已被修复公开技术细节，并由此形成技术分析漏洞的修复方式。

本文首先简单介绍 V8 的回收机制，然后结合具体漏洞 PoC 分析漏洞成因。


# V8回收回收机制

回收一直是 V8 引擎的优化重点，是分析复杂优化组合的机制，其主要采用的跟踪回收算法，在堆放上分代尺寸，大致可以形成使用新生代和老年代，具体回收策略可分为Major GC（Mark-Compact）和Minor GC(Scavenger)。这里只介绍代码对策略的实现分为两个阶段的关键阶段，可以从参考文档和源进行学习。

## Major GC（Mark-Compact）

V8的主要GC负责对堆区的垃圾进行回收，可实分为、、整理阶段，清除阶段释放不使用内存，整理阶段将使用内存移动压，算法的重点在整个阶段标记。

阶段中，需要收集发现并标记所有对象的活动。收集器从维护中没有开始追踪追踪发现更多新对象的对象，持续标记发现的对象并附随器，直到需要标记的对象。

![image.png](https://s2.loli.net/2022/09/04/qQGbu4mciXVK2pI.png)

V8 使用三色标记来标注对象，每个对象通过后一个标记位和一个标记来标记，两个标记位标记颜色颜色：（00）、（10）和黑色（1​​1）。所有对象都是白色的工作物，当收集物品最初显示其到发现标记列表时，会变成灰色。当收集器从标记列表器中弹出它并访问其所有时间时，对象变为白色当不再有灰色物体标记完成时，所有剩余的黑色透明地都无法到达，，可以回收。

![image.png](https://s2.loli.net/2022/09/04/opRJ4nOh6fWL3X7.png)

## Minor GC

GC的主要工作在新生代阶段，这些都是可以划分、疏散和精准的阶段，这些都是没有准确的跨阶段交错的空间，要从空间和新生代的空间划分中执行。为了-这两个空间分配的对象管理人员出现在从-空间分级表开始回收完成，Scavenger 继续和交换未来的对象后移动到-空间交换，在空间与新的连接，在空间与新的连接From-Space和To-Space，开始下一轮GC。
![image.png](https://s2.loli.net/2022/09/04/Ub2QHA8asujPTiz.png)

这里需要特别介绍障碍（Write-Barrier）机制，它是这个漏洞发生的关键。W-Barrier 维护了一组从旧对象到新对象的指针列表，一般是老旧指向年轻一代中的对象的原因，使用这个引用列表可以直接进行标记，不需要跟踪整个旧的。
``` javascript
// Called after atomic_relaxed_write(&object.field, value);
write_barrier(object, field_offset, value) {
if (color (value) == white &&atomic_color_transition(value, white, grey)) {
marking_worklist.push(value);
    }
}
```

>可以看到，Write-Barrier 会将一个关联的可访问对象标记为灰色，并在其中标注 valuemarking_worklist，中的标记程序可以允许再遍历旧的对象，直接从列表开始进行标记。

# 漏洞分析

Chrome V8命令执行漏洞（CVE-2022-1310）出现在V8引擎的正则表达式模块，如下在报告中提到的漏洞PoC关键代码：
``` javascript

var re = new RegExp('foo', 'g');
re.exec = function() {
    gc(); // move `re` to oldspace using a mark-sweep gc
    delete re.exec; // transition back to initial regexp map to pass HasInitialRegExpMap
    re.lastIndex = 1073741823; // maximum smi, adding one will result in a HeapNumber
    RegExp.prototype.exec = function() {
        throw ''; // break out of Regexp.replace
    }
    return ...;
};

try {
    var newstr = re[Symbol.replace]("fooooo", ".$"); // trigger
} catch(e) {}

gc({type:'minor'});
%DebugPrint(re.lastIndex);
```
`re[Symbol.replace]`通过对比PoC和分析源码，当在JS代码中调用函数时，V8引擎使用`Runtime_RegExpReplaceRT`函数进行处理，函数中的异常退出分支会调用，该函数最终将加1并写回对象中。`RegExpUtils::SetAdvancedStringIndexre.lastIndex`
![image.png](https://s2.loli.net/2022/09/04/78YphxgPbtmuZcK.png)

V8中的数字类型Smi和HeapNumber ，Smi代表了小函数中的代码，和对象中的数据`re.lastIndex += 1`溢出。指针共享存储空间，通过的最低位是否为0来值类型，Smi表示会在堆中创建`HeapNumber`对象来的范围，在3个2位下，Smi值为-2^30 2^30 - 1。

![image.png](https://s2.loli.net/2022/09/04/boy2X3auPBHG18z.png)

可知当我们对RegExp对象范围内的`RegExp_Regionre.lastIndex=1073741823`时，并ExpReplaceRT逻辑函数超过3个时，由于加了1个之后的值1010个Smi的表示值V 8 在引擎中的对象中申请了一个V 8 重来存储新对象的lastIndex，此时，该RegExp对象的lastIndex属性不再是一个Smi数，而是一个指向堆中HeapNumber对象的指针。如下图所示：

![image.png](https://s2.loli.net/2022/09/04/MLKTCkliEnxUj3g.png)

>在之前的垃圾回收中，V8的Minor GC的Write-Barrier需要对将新生代内存中添加的新建对象置灰并到标记列表中，以省略对旧机制对象的遍历。但函数SetLastIndex在处理RegExp对象存在优先映射情况的代码分支中，默认lastIndex是一个Smier标记当跳过了写屏障。因此，relastIndex变成了HeapNumber对象，又没有被Write-Barrier标记，所以在似乎最容易被释放回收的对象，释放释放后重新释放。最后一个索引属性就变成了一个悬垂的位置，该对象被指向了一个对象的空间，再次尝试空间，就产生了了Use-After-Free漏洞。

![image.png](https://s2.loli.net/2022/09/04/1H7Wpl428jJLX5h.png)

CVE-2022-1310是一个典型的 UAF 漏洞，触发可以通过堆喷重新分配释放后的内存空间达到利用的目的

![image.png](https://s2.loli.net/2022/09/04/4uGBkaVqDoKvIWJ.png)

# 总结

漏洞（202-1310）出现的根本原因是因为是8在Write-VE-的时候，没有考虑泄露数据泄露的情况，没有考虑到数字泄露值的处理情况，数字类型的对象类型新分配机制的堆UAF，最终导致了任意执行，修复方案也非常简单，将`SKIP_WRITE_BARRIER标记改成UPDATE_WRITE_BARRIER即可。`

![image.png](https://s2.loli.net/2022/09/04/jonfLqVEgmQbUu7.png)

# 参考资料
+ https://bugs.chromium.org/p/chromium/issues/detail?id=1307610

+ https://v8.dev/blog/trash-talk

+ https://v8.dev/blog/concurrent-marking

+ https://chromium.googlesource.com/v8/v8/+/bdc4f54a50293507d9ef51573bab537883560cc8%5E%21/